<div class="d-flex justify-content-center align-items-center py-5 min-vh-100 bg-light">
  <div class="rounded-4 p-4 shadow-lg bg-white" style="max-width: 720px; width: 90%;">

    <div class="d-flex align-items-center gap-3 mb-4 p-3 shadow rounded" style="background-color: #59683b;">
      <div style="width: 40px; height: 40px;">
        <img src="<%= @trip.user.user_image_url %>" alt="<%= @trip.user.username %>'s avatar" class="rounded-circle w-100 h-100" style="object-fit: cover;" />
      </div>
      <div>
        <p class="mb-0 fs-3 archivo-black" style="color: #F2EED7;"><%= @trip.user.username %></p>
        <small class="d-block mb-1" style="color: #F2EED7;">
          Created <strong><%= @trip.location %> trip</strong> <%= time_ago_in_words(@trip.created_at) %> ago
        </small>
        <small style="color: #F2EED7;">
          From <strong><%= @trip.start_date.strftime('%B %d, %Y') %></strong> to <strong><%= @trip.end_date.strftime('%B %d, %Y') %></strong>
        </small>
      </div>
    </div>

    <div class="text-center">
      <% if current_user == @trip.user %>
        <% remaining_friends = current_user.confirmed_friends.reject { |f| @trip.users.include?(f) } %>
        <% if remaining_friends.any? %>
          <div class="dropdown d-inline-block mb-3">
            <button class="btn btn-secondary dropdown-toggle" type="button" id="friendDropdown" data-bs-toggle="dropdown" aria-expanded="false" style="color: #59683b; border-color: #59683b;">
              Add Friend to Trip
            </button>
            <ul class="dropdown-menu" aria-labelledby="friendDropdown" style="min-width: 220px;">
              <% remaining_friends.each do |friend| %>
                <li>
                  <a href="#" class="dropdown-item d-flex align-items-center gap-2 add-friend-to-trip" data-user-id="<%= friend.id %>" style="color: #59683b;">
                    <img src="<%= friend.user_image_url %>" alt="<%= friend.username %>'s avatar"  class="rounded-circle"  style="width: 28px; height: 28px; object-fit: cover; display: block;">
                    <span><%= friend.username %></span>
                  </a>
                </li>
              <% end %>
            </ul>
          </div>
        <% else %>
          <p class="text-muted mb-3">No more friends to add.</p>
        <% end %>
      <% else %>
        <% if @trip.users.any? %>
          <p class="text-muted mb-3">Users added to trip</p>
        <% else %>
          <div style="height: 2.5rem;"></div>
        <% end %>
      <% end %>

      <ul id="trip-participants-list" class="list-group mx-auto" style="max-width: 500px;">
        <% @trip.users.each do |user| %>
          <li class="list-group-item d-flex align-items-center gap-3">
            <img src="<%= user.user_image_url %>" alt="<%= user.username %>'s avatar" class="rounded-circle" style="width: 28px; height: 28px; object-fit: cover;">
            <%= link_to user.username, user_path(user), class: "fw-semibold text-decoration-none", style: "color: #59683b;" %>
          </li>
        <% end %>
      </ul>
    </div>

    <hr class="my-4">

    <% if @trip.trip_activities.any? %>
      <% activities_by_day = @trip.trip_activities.includes(:activity).group_by { |ta| ta.day || 1 } %>
      <% sorted_days = activities_by_day.keys.sort %>

      <div id="activitiesCarousel" class="carousel slide" data-bs-ride="false" data-bs-interval="false">
        <div class="carousel-inner">
          <% sorted_days.each_with_index do |day, index| %>
            <div class="carousel-item <%= 'active' if index == 0 %>">
              <div class="d-flex justify-content-between align-items-center mb-4">
                <% if sorted_days.size > 1 %>
                  <button class="btn btn-link" type="button" data-bs-target="#activitiesCarousel" data-bs-slide="prev" aria-label="Previous day" style="color: #59683b;">
                    <i class="bi bi-chevron-left fs-3"></i>
                  </button>
                <% else %>
                  <div style="width: 40px;"></div>
                <% end %>


              <div class="d-flex justify-content-center align-items-center mb-4 p-3 rounded shadow" style="background-color: #59683b;">
                <p class="text-center fs-3 flex-grow-1 m-0 archivo-black" style="color: #F2EED7;">
                  Day <%= day %> â€” <%= (@trip.start_date + (day - 1)).strftime('%B %d, %Y') %>
                </p>
              </div>

                <% if sorted_days.size > 1 %>
                  <button class="btn btn-link" type="button" data-bs-target="#activitiesCarousel" data-bs-slide="next" aria-label="Next day" style="color: #59683b;">
                    <i class="bi bi-chevron-right fs-3"></i>
                  </button>
                <% else %>
                  <div style="width: 40px;"></div>
                <% end %>
              </div>

              <ul class="list-group mb-4">
                <% activities_by_day[day].sort_by { |ta| ta.start_time || Time.new(2100) }.each do |ta| %>
                  <% activity = ta.activity %>
                  <li class="list-group-item mb-3 rounded-3 shadow-sm border border-light">
                    <div class="d-flex gap-3 align-items-start flex-wrap">
                      <% if activity.image_url.present? %>
                        <div class="activity-image flex-shrink-0" style="width: 120px; height: 80px;">
                          <img src="<%= activity.image_url %>" alt="<%= activity.name %> image" class="rounded" style="width: 100%; height: 100%; object-fit: cover;" />
                        </div>
                      <% end %>

                      <div class="flex-grow-1 d-flex flex-column gap-2">
                        <h5 class="fw-bold mb-1" style="color: #59683b;">
                          <%= h activity.name %>
                        </h5>
                        <p class="fst-italic text-muted mb-1"><%= h activity.address %></p>
                        <p class="mb-2"><%= h activity.description %></p>

                        <% if ta.start_time && ta.end_time %>
                          <p class="fw-semibold mb-1" style="color: #59683b;">
                            <i class="bi bi-clock me-1"></i>
                            <%= ta.start_time.strftime("%I:%M %p") %> - <%= ta.end_time.strftime("%I:%M %p") %>
                          </p>
                        <% end %>

                        <% if activity.cost.present? %>
                          <p class="fw-semibold mb-1" style="color: #59683b;">
                            <i class="bi bi-cash me-1"></i>
                            Estimated Cost: <%= h activity.cost %>
                          </p>
                        <% end %>
                      </div>
                    </div>
                  </li>
                <% end %>
              </ul>
            </div>
          <% end %>
        </div>
      </div>
    <% else %>
      <p class="text-muted fst-italic mt-4 text-center">No activities planned yet.</p>
    <% end %>

  </div>
</div>

<style>
  .activity-image img {
    border-radius: 0.5rem;
    width: 200px;
    height: 160px;
    object-fit: cover;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  }

  @media (max-width: 576px) {
    .list-group-item .d-flex {
      flex-direction: column !important;
      align-items: flex-start !important;
    }
    .activity-image img {
      width: 100%;
      height: auto;
      max-height: 300px;
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".add-friend-to-trip").forEach(item => {
      item.addEventListener("click", async (e) => {
        e.preventDefault();
        const userId = e.currentTarget.dataset.userId;
        const tripId = <%= @trip.id %>;

        const response = await fetch("/trip_users", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": document.querySelector("[name='csrf-token']").content
          },
          body: JSON.stringify({ user_id: userId, trip_id: tripId })
        });

        if (response.ok) {
          const data = await response.json();

          const list = document.getElementById("trip-participants-list");
          const newItem = document.createElement("li");
          newItem.className = "list-group-item d-flex align-items-center gap-2";
          newItem.innerHTML = `
            <img src="${data.user_image_url}" alt="${data.username}'s avatar" class="rounded-circle" style="width: 24px; height: 24px; object-fit: cover;">
            <a href="/users/${data.user_id}" class="fw-semibold text-decoration-none" style="color: #59683b;">${data.username}</a>
          `;
          list.appendChild(newItem);

          e.currentTarget.closest("li").remove();
        } else {
          alert("Failed to add friend to trip");
        }
      });
    });
  });
</script>
